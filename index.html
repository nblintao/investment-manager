<html>

<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.css" />
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <script src="investment_manager.js"></script>
    <script>
        // This is a sample js function that takes two inputs and returns two objects
        function processInputs(inputCSV, inputConfig) {
            // Do some processing here
            var output1 = { name: inputCSV, age: Math.floor(Math.random() * 100), gender: "male" };
            var output2 = { name: inputConfig, age: Math.floor(Math.random() * 100), gender: "female" };
            return [output1, output2];
        }

        // This is a helper function that converts an object to a table
        function objectToTable(obj) {
            var table = document.createElement("table");
            table.border = "1";
            for (var key in obj) {
                var row = document.createElement("tr");
                var cell1 = document.createElement("td");
                var cell2 = document.createElement("td");
                cell1.innerHTML = key;
                cell2.innerHTML = obj[key];
                row.appendChild(cell1);
                row.appendChild(cell2);
                table.appendChild(row);
            }
            return table;
        }

        // This is the main function that handles the button click event
        function handleClick() {
            // Get the inputs from the text boxes
            var inputCSV = document.getElementById("inputCSV").value;
            var inputConfig = JSON.parse(document.getElementById("inputConfig").value);

            // Call the processInputs function and get the outputs
            var outputs = main(inputCSV, inputConfig);
            var allEquityInfo = outputs[0];
            var plan = outputs[1];


            let renderNum = $.fn.dataTable.render.number(',', '.', 3, '');

            let table = $('#allEquityInfo').DataTable({
                data: allEquityInfo,
                paging: false,
                columns: [

                    {
                        data: 'symbol',
                        title: 'Symbol',
                    },
                    {
                        data: 'quantity',
                        title: 'Shares',
                        render: renderNum,
                        className: "dt-body-right",
                    },
                    {
                        data: 'price',
                        title: 'Price$',
                        render: renderNum,
                        className: "dt-body-right",
                    },
                    {
                        data: 'marketValue',
                        title: 'Market Value$',
                        render: renderNum,
                        className: "dt-body-right",
                    },
                    {
                        data: 'source',
                        title: 'Source',
                    },
                    {
                        data: 'mapTo',
                        title: 'Map To',
                    },
                ]
            });

            $('#plan').DataTable({
                "autoWidth": true,
                data: plan.planList,
                paging: false,
                columns: [
                    {
                        data: 'symbol',
                        title: 'Symbol',
                    },
                    {
                        data: 'oldMarketValue',
                        title: 'Old$',
                        render: renderNum,
                        className: "dt-body-right",
                    },
                    {
                        data: 'oldPercentage',
                        title: 'Old%',
                        render: renderNum,
                        className: "dt-body-right",
                    },
                    {
                        data: 'expectPercentage',
                        title: 'Expect%',
                        render: renderNum,
                        className: "dt-body-right",
                    },
                    {
                        data: 'expectMarketValue',
                        title: 'Expect$',
                        render: renderNum,
                        className: "dt-body-right",
                    },
                    {
                        data: 'addValueNeeded',
                        title: 'Add$ (Need)',
                        render: renderNum,
                        className: "dt-body-right",
                    },
                    {
                        data: 'price',
                        title: 'Price$',
                        render: renderNum,
                        className: "dt-body-right",
                    },
                    {
                        data: 'addShares',
                        title: 'Add Shares',
                        render: renderNum,
                        className: "dt-body-right",
                    },
                    {
                        data: 'addValueActual',
                        title: 'Add$ (Actual)',
                        render: renderNum,
                        className: "dt-body-right",
                    },
                    {
                        data: 'newMarketValue',
                        title: 'New$',
                        render: renderNum,
                        className: "dt-body-right",
                    },
                    {
                        data: 'newPercentage',
                        title: 'New%',
                        render: renderNum,
                        className: "dt-body-right",
                    },
                ]
            });

            console.log(plan.planList)

            let cash = plan.cash;
            let bufferCash = plan.bufferCash;
            let addValueActual = plan.addValueActual;
            let bufferCashActual = plan.bufferCashActual;

            pieBefore = []
            pieAfter = []
            for (let i = 0; i < plan.planList.length; i++) {
                const e = plan.planList[i];
                pieBefore.push({ name: e.symbol, value: e.oldMarketValue })
                pieAfter.push({ name: e.symbol, value: e.newMarketValue })
            }
            pieBefore.push({ name: "Cash to Invest", value: cash - bufferCash })
            pieBefore.push({ name: "Cash Buffer", value: bufferCash })

            pieAfter.push({ name: "", value: 0 })
            pieAfter.push({ name: "Cash Buffer", value: bufferCashActual })

            WIDTH = 500;


            SETTINGS = {
                name: d => d.name,
                value: d => d.value,
                width: WIDTH,
                height: WIDTH,
                colors: d3.schemeTableau10,
                format: "$,.2f"
            }
            document.getElementById("pieBefore").appendChild(PieChart(pieBefore, SETTINGS));
            document.getElementById("pieAfter").appendChild(PieChart(pieAfter, SETTINGS));

            let fmt = function (num) {
                const options = {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                };
                return Number(num).toLocaleString('en', options);
            };
            document.getElementById("planInfo").innerHTML = `
                Cash Before: ${fmt(cash)}<br/>
                > Invest ${fmt(cash - bufferCash)}<br/>
                > Buffer ${fmt(bufferCash)}<br/>
                Actual Invested: ${fmt(addValueActual)}<br/>
                Cash After: ${fmt(bufferCashActual)}<br/>
                > Buffer ${fmt(bufferCashActual)} <br/>
            `
        }

    </script>
</head>

<body>
    <textarea id="inputCSV" rows="50" cols="80"></textarea>
    <textarea id="inputConfig" rows="50" cols="80"></textarea>
    <button onclick="handleClick()">规划</button>
    <table id="allEquityInfo" clas="display"></table>
    <table id="plan" clas="display"></table>
    <div style="display: flex;">
        <div id="pieBefore"></div>
        <div id="pieAfter"></div>
    </div>

    <p id="planInfo"></p>

    <script>
        document.getElementById("inputCSV").value = INIT_SCHWAB_CSV
        document.getElementById("inputConfig").value = JSON.stringify(INIT_PERSONAL_CONFIG, null, 2);
        handleClick();
    </script>
</body>

</html>